#!/usr/bin/python
from wsgiref.simple_server import make_server
from wsgiref.handlers import BaseHandler
from html_wsgi import *
from lib import *
import config
import time, mimetypes, os

#TODO
load_language("")

def hello_world():
    return "Jieppie"
urls = {
   "/"              : hello_world,
}

def serve_static(filename, root):
    # Security Problem:
    # This function van may serve every file in filesystem
    # so just to be shure:
    filename = filename.lstrip('/')
    if filename.find('..') != -1:
        raise StandardError("Filename contains '..'")
    headers = [] 
    filename = root + '/' + filename 
    mimetype, encoding = mimetypes.guess_type(filename)
    headers.append(('Content-Type', mimetype))
    headers.append(('Content-Encoding', str(encoding)))

    stats = os.stat(filename)
    headers.append(('Content-Length', str(stats.st_size)))
    headers.append(('Last-Motified', time.strftime("%a, %d %b %Y %H:%M:%S GMT", time.gmtime(stats.st_mtime))))
    body = open(filename, 'rb')
    return body, headers

def main_handler(environ, start_response):
    html = html_wsgi(environ)

    requested_url = environ['PATH_INFO']
    target = urls.get(requested_url)
    
    # This target is a static file
    if not target:
        try:
           body, headers = serve_static(requested_url, environ['PWD'])
           start_response('200 OK', headers)
           return body
        except OSError:
            start_response('404 Not found', [ ('Content-type', 'text/plain')] )
            return "File not found"
    
    status = '200 OK' # HTTP Status
    headers = [('Content-type', 'text/html')] # HTTP Headers
    start_response(status, headers)

    html.header()
    html.write(target())
    #html.write(str(environ))
    html.footer()

    return html.output

httpd = make_server('', 6555, main_handler)
httpd.serve_forever()


