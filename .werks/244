Title: New features for WATO page Backup & Restore
Level: 2
Component: wato
Class: feature
State: unknown
Version: 1.2.5i1
Date: 1387198415
Targetversion: future

H1:Introduction
The entire monitoring environment with its configurations, performance data, historic data is a
collection of files and folders. So if we want to create a snapshot of the current setup all
we have to do is to pack these files into a tarball. This tarball can be applied on the
same site (configuration rollback) or applied onto an other monitoring instance.

H1:Snapshot backup domains
Version <b class=new>1.2.4</b> introduces configurable snapshots. With this new feature you can select the components, also
called backup domains, which should get included into the snapshot. Additionally you can provide a comment which is also stored in the snapshot.
The following components are currently available

<img border=0 src="bilder/extended_backup.png" width=617></a>

As you see, some of them are enabled by default. Those default backup domains are included in
automatically generated snapshots, which are created when you press the "Activate Changes!" button, for example.

H1:Restoring snapshots
Most of the time snapshots won't have all configurable backup domains included, but only the default configuration.
Therefore we can't apply these snapshots like in previous version:
<ul>
<li>Remove all possible target files and directories</li>
<li>Extract snapshot into the target directories</li>
</ul>


Now a snapshot is extracted in a more detailed manner:
<ul>
<li>Look into the snapshot and determine backup domains</li>
<li>Remove all target files and directories only from these domains</li>
<li>Extract each domain in its target directory</li>
</ul>

So if we have a snapshot containing only "Automatically detected services", no other directories than
the autochecks directory will be emptied upon application. You can find more detailed information about each
backup domains files and directories in the following chapter.

<b>Important:</b><br>
Keep in mind that whenever a backup domain is restored, any of its current data is completely removed.<br>
If you restore a snapshot containing "Performance Data" for example, all recent performance data is lost.

H1:Configuration details
The following four backup domains are the <b>default domains</b>.<br>
When you press the "Activate Changes!" button, these domains are automatically included into the snapshot.<br>

<ul>
<li>Hosts, Services, Groups, Timeperiods, Business Intelligence and Monitoring Configuration</li>
This incluces all configuration files generated by WATO and check_mk.<br>
Path prefix: <tt>defaults.default_config_dir</tt>
<table style='width: 250px'><tr><th width=50>Type</th><th>Relative Path</th></tr>
<tr><td>File</td><td>liveproxyd.mk</td></tr>
<tr><td>File</td><td>main.mk</td></tr>
<tr><td>File</td><td>final.mk</td></tr>
<tr><td>File</td><td>local.mk</td></tr>
<tr><td>File</td><td>mkeventd.mk</td></tr>
<tr><td>Directory</td><td>conf.d</td></tr>
<tr><td>Directory</td><td>multisite.d</td></tr>
<tr><td>Directory</td><td>mkeventd.d</td></tr>
<tr><td>Directory</td><td>mknotifyd.d</td></tr>
</table>
<br>

<li>Personal User Settings and Custom Views</li>
The users bookmarks, views, viewoptions, current state of foldable elements and more.<br>
Path prefix: <tt>defaults.var_dir</tt>
<table style='width: 250px'><tr><th width=50>Type</th><th>Relative Path</th></tr>
<tr><td>Directory</td><td>web</td></tr>
</table>
<br>

<li>Local Authentication Data</li>
Anything the user needs for the authentication in multisite<br>
Path prefix: dirname of <tt>defaults.htpasswd_file</tt>
<table style='width: 250px'><tr><th width=50>Type</th><th>Relative Path</th></tr>
<tr><td>File</td><td>htpasswd</td></tr>
<tr><td>File</td><td>auth.secret</td></tr>
<tr><td>File</td><td>auth.serials</td></tr>
</table>
<br>

<li>Event Console Configuration</li>
The status of the event console and its configuration. This does <b>not</b> include the archived events.<br>
Path prefix: <tt>defaults.omd_root</tt>
<table style='width: 250px'><tr><th width=50>Type</th><th>Relative Path</th></tr>
<tr><td>Directory</td><td>etc/check_mk/mkeventd.d</td></tr>
</table>
</ul>
<br>

<br>
Furthermore you can choose to add additional backup domains to the snapshot.
<ul>
<li>Automatically Detected Services</li>
Files created during a check mk inventory <tt>cmk -I {hostname}</tt>.<br>
Path prefix: <tt>defaults.autochecksdir</tt>
<table style='width: 250px'><tr><th width=50>Type</th><th>Relative Path</th></tr>
<tr><td>Directory</td><td>.</td></tr>
</table>
<br>

<li>Stored SNMP Walks</li>
Walks created with the command <tt>cmk --snmpwalk {hostname}</tt>.<br>
Path prefix <tt>defaults.snmpwalks_dir</tt>
<table style='width: 250px'><tr><th width=50>Type</th><th>Relative Path</th></tr>
<tr><td>Directory</td><td>.</td></tr>
</table>
<br>

<li>Monitoring History</li>
The logfiles from the monitoring cores. <br>
Path prefix: <tt>defaults.omd_root</tt>
<table style='width: 250px'><tr><th width=50>Type</th><th>Relative Path</th></tr>
<tr><td>Directory</td><td>var/nagios/archive</td></tr>
<tr><td>File</td><td>var/nagios/nagios.log</td></tr>
<tr><td>Directory</td><td>var/icinga/archive</td></tr>
<tr><td>File</td><td>var/icinga/icinga.log</td></tr>
<tr><td>Directory</td><td>var/check_mk/core/archive</td></tr>
<tr><td>File</td><td>var/check_mk/core/history</td></tr>
</table>
<br>

<li>Performance Data</li>
Round robin data required to render the pnp4nagios graphs.<br>
Path prefix: <tt>defaults.omd_root</tt>
<table style='width: 250px'><tr><th width=50>Type</th><th>Relative Path</th></tr>
<tr><td>Directory</td><td>var/pnp4nagios/perfdata</td></tr>
<tr><td>Directory</td><td>var/rrdcached</td></tr>
</table>
<br>

<li>Application Logs</li>
The logfiles of varios applications.<br>
Path prefix: <tt>defaults.omd_root</tt>
<table style='width: 250px'><tr><th width=50>Type</th><th>Relative Path</th></tr>
<tr><td>Directory</td><td>var/log</td></tr>
<tr><td>File</td><td>var/check_mk/notify/notify.log</td></tr>
<tr><td>File</td><td>var/nagios/livestatus.log</td></tr>
<tr><td>Directory</td><td>var/pnp4nagios/log</td></tr>
</table>
<br>

<li>Event Console Archive and Current State</li>
The current state and all archived events of the Event Console.<br>
Path prefix: <tt>defaults.omd_root</tt>
<table style='width: 250px'><tr><th width=50>Type</th><th>Relative Path</th></tr>
<tr><td>Directory</td><td>var/mkeventd/history</td></tr>
<tr><td>File</td><td>var/mkeventd/status</td></tr>
</table>
<br>

<li>NagVis Maps, Configurations and User Files</li>
All nagios related configurations and maps.<br>
<b>Note:</b><br>Some NagVis configuration files contain absolute paths with the site name in it.<br>
You might have problems applying them to a site with a different name.<br>
Path prefix <tt>defaults.omd_root</tt>
<table style='width: 250px'><tr><th width=50>Type</th><th>Relative Path</th></tr>
<tr><td>Directory</td><td>local/share/nagvis</td></tr>
<tr><td>Directory</td><td>etc/nagvis</td></tr>
<tr><td>Directory</td><td>var/nagvis</td></tr>
</table>
<br>

<li>Doku Wiki Pages and Settings</li>
Path prefix <tt>defaults.omd_root</tt>
<table style='width: 250px'><tr><th width=50>Type</th><th>Relative Path</th></tr>
<tr><td>Directory</td><td>var/dokuwiki</td></tr>
</table>
<br>

<li>Logwatch Data</li>
The persisted data (current state) of the check_mk logwatch checks<br>
Path prefix <tt>defaults.var_dir</tt>
<table style='width: 250px'><tr><th width=50>Type</th><th>Relative Path</th></tr>
<tr><td>Directory</td><td>logwatch</td></tr>
</table>

</ul>
