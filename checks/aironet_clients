#!/usr/bin/python

aironet_default_strength_levels = (-80, -70)
aironet_default_quality_levels = (40, 20)

def inventory_aironet_clients(checkname, info):
    if len(info) > 0:
	return [("strength", "", aironet_default_strength_levels),
                ("quality", "", aironet_default_quality_levels),
		("clients", "", None)]
    else:
	return []

def check_aironet_clients(item, params, info):
    if len(info) == 0:
	return (0, "OK - No clients currently logged in")

    if item == "clients":
	return (0, "OK - %d clients currently logged in" % len(info),
		[("clients", len(info), None, None, 0, None)])

    # item = "quality" or "strength"
    if item == "quality":
	index = 1
	mmin = 0
	mmax = 100
	unit = "%"
	neg = 1
    else:
	index = 0 
	mmin = None
	mmax = 0
	unit = "dB"
	neg = -1

    avg = sum([int(line[index]) for line in info]) / float(len(info))
    warn, crit = params
    perfdata = [(item, avg, warn, crit, mmin, mmax)] 
    infotxt = " - signal %s at %.1f%s (warn/crit at %s%s/%s%s)" % \
	(item, avg, unit, warn, unit, crit, unit)

    if neg * avg <= neg * crit:
        return (2, "CRIT" + infotxt, perfdata)
    elif neg * avg <= neg * warn:
        return (1, "WARN" + infotxt, perfdata)
    else:
        return (0, "OK" + infotxt, perfdata)

	
	 

check_info['aironet_clients'] = ( check_aironet_clients, "Average client signal %s", 1, inventory_aironet_clients )
snmp_info['aironet_clients'] = ( ".1.3.6.1.4.1.9.9.273.1.3.1.1", [ 3, 4 ])

# CISCO-DOT11-ASSOCIATION-MIB::cDot11ClientSignalStrength
# CISCO-DOT11-ASSOCIATION-MIB::cDot11ClientSigQuality

snmp_scan_functions['aironet_clients'] \
	= lambda oid: oid(".1.3.6.1.2.1.1.2.0") == ".1.3.6.1.4.1.9.1.685"
