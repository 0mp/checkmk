#!/bin/bash
# 
# Diese Skript wird bei jeder Notifikation durch Nagios
# aufgerufen. In Umgebungsvariablen mit $NAGIOS_... bekommt
# es alle Kontextinformationen.
# Zum Testen der Variablen:

# set | grep NAGIOS_ | sort > /tmp/nagios.env
# Beispiel: 
# NAGIOS_COMMANDFILE=/var/run/nagios/rw/nagios.cmd
# NAGIOS_CONTACTALIAS='RZ Notfall'
# NAGIOS_CONTACTEMAIL=rz-emergency@localhost
# NAGIOS_CONTACTGROUPALIAS='Alle Kontakte'
# NAGIOS_CONTACTGROUPMEMBERS=rz-emerg,rz-infra
# NAGIOS_CONTACTGROUPNAME=all
# NAGIOS_CONTACTGROUPNAMES=all
# NAGIOS_CONTACTNAME=rz-emerg
# NAGIOS_DATE=2010-01-19
# NAGIOS_EVENTSTARTTIME=1263919318
# NAGIOS_HOSTACTIONURL='/pnp4nagios/graph?host=s06_usv1'
# NAGIOS_HOSTADDRESS=192.168.1.50
# NAGIOS_HOSTALIAS=s06_usv1
# NAGIOS_HOSTATTEMPT=1
# NAGIOS_HOSTCHECKCOMMAND=check-mk-ping
# NAGIOS_HOSTCHECKTYPE=ACTIVE
# NAGIOS_HOSTDISPLAYNAME=s06_usv1
# NAGIOS_HOSTDOWNTIME=0
# NAGIOS_HOSTDURATION='0d 1h 13m 5s'
# NAGIOS_HOSTDURATIONSEC=4385
# NAGIOS_HOSTEVENTID=0
# NAGIOS_HOSTEXECUTIONTIME=0.022
# NAGIOS_HOSTGROUPALIAS=USV
# NAGIOS_HOSTGROUPMEMBERS=ad214_usv1,ik026_usv1,s06_usv1,s06_usv2,s48_usv1
# NAGIOS_HOSTGROUPNAMES=usv
# NAGIOS_HOSTGROUPNAME=usv
# NAGIOS_HOSTLATENCY=0.400
# NAGIOS_HOSTNAME=s06_usv1
# NAGIOS_HOSTNOTIFICATIONID=0
# NAGIOS_HOSTNOTIFICATIONNUMBER=0
# NAGIOS_HOSTOUTPUT='OK - 192.168.1.50: rta 3,014ms, lost 0%'
# NAGIOS_HOSTPERCENTCHANGE=0.00
# NAGIOS_HOSTPERFDATAFILE=/var/spool/nagios/pnp/host-perfdata
# NAGIOS_HOSTPERFDATA='rta=3,014ms;200,000;500,000;0; pl=0%;40;80;; rtmax=3,916ms;;;; rtmin=2,543ms;;;;'
# NAGIOS_HOSTPROBLEMID=0
# NAGIOS_HOSTSTATEID=0
# NAGIOS_HOSTSTATETYPE=HARD
# NAGIOS_HOSTSTATE=UP
# NAGIOS_LASTHOSTCHECK=1263919442
# NAGIOS_LASTHOSTDOWN=0
# NAGIOS_LASTHOSTEVENTID=0
# NAGIOS_LASTHOSTPROBLEMID=0
# NAGIOS_LASTHOSTSTATECHANGE=1263915110
# NAGIOS_LASTHOSTSTATEID=0
# NAGIOS_LASTHOSTSTATE=UP
# NAGIOS_LASTHOSTUNREACHABLE=0
# NAGIOS_LASTHOSTUP=1263919443
# NAGIOS_LASTSERVICECHECK=1263919456
# NAGIOS_LASTSERVICECRITICAL=0
# NAGIOS_LASTSERVICEEVENTID=0
# NAGIOS_LASTSERVICEOK=1263919456
# NAGIOS_LASTSERVICEPROBLEMID=0
# NAGIOS_LASTSERVICESTATECHANGE=1263916696
# NAGIOS_LASTSERVICESTATEID=0
# NAGIOS_LASTSERVICESTATE=OK
# NAGIOS_LASTSERVICEUNKNOWN=0
# NAGIOS_LASTSERVICEWARNING=0
# NAGIOS_LOGFILE=/var/log/nagios/nagios.log
# NAGIOS_LONGDATETIME='Tue Jan 19 17:44:55 CET 2010'
# NAGIOS_MAINCONFIGFILE=/etc/nagios/nagios.cfg
# NAGIOS_MAXHOSTATTEMPTS=1
# NAGIOS_MAXSERVICEATTEMPTS=1
# NAGIOS_NOTIFICATIONAUTHOR=nagiosadmin
# NAGIOS_NOTIFICATIONCOMMENT=of
# NAGIOS_NOTIFICATIONNUMBER=0
# NAGIOS_NOTIFICATIONRECIPIENTS=rz-emerg,check_mk
# NAGIOS_NOTIFICATIONTYPE=RECOVERY
# NAGIOS_OBJECTCACHEFILE=/var/cache/nagios/objects.cache
# NAGIOS_PROCESSSTARTTIME=1263919317
# NAGIOS_RESOURCEFILE=/etc/nagios/resource.cfg
# NAGIOS_RETENTIONDATAFILE=/var/lib/nagios/retention.dat
# NAGIOS_SERVICEACTIONURL='/pnp4nagios/graph?host=s06_usv1&srv=Power+phase+1'
# NAGIOS_SERVICEATTEMPT=1
# NAGIOS_SERVICECHECKCOMMAND=check_mk-apc_symmetra_power
# NAGIOS_SERVICECHECKTYPE=PASSIVE
# NAGIOS_SERVICEDESC='Power phase 1'
# NAGIOS_SERVICEDISPLAYNAME='Power phase 1'
# NAGIOS_SERVICEDOWNTIME=0
# NAGIOS_SERVICEDURATION='0d 0h 46m 39s'
# NAGIOS_SERVICEDURATIONSEC=2799
# NAGIOS_SERVICEEVENTID=0
# NAGIOS_SERVICEEXECUTIONTIME=0.000
# NAGIOS_SERVICEISVOLATILE=0
# NAGIOS_SERVICELATENCY=0.636
# NAGIOS_SERVICENOTIFICATIONID=9762
# NAGIOS_SERVICENOTIFICATIONNUMBER=0
# NAGIOS_SERVICEOUTPUT='OK - current power: 9940 W, warn/crit at and below 20/1 W'
# NAGIOS_SERVICEPERCENTCHANGE=0.00
# NAGIOS_SERVICEPERFDATAFILE=/var/spool/nagios/pnp/service-perfdata
# NAGIOS_SERVICEPERFDATA='power=9940;20;1;0;'
# NAGIOS_SERVICEPROBLEMID=0
# NAGIOS_SERVICESTATEID=0
# NAGIOS_SERVICESTATE=OK
# NAGIOS_SERVICESTATETYPE=HARD
# NAGIOS_SHORTDATETIME='2010-01-19 17:44:55'
# NAGIOS_STATUSDATAFILE=/var/spool/nagios/status.dat
# NAGIOS_TEMPFILE=/var/spool/nagios/nagios.tmp
# NAGIOS_TEMPPATH=/var/spool/nagios/tmp
# NAGIOS_TIME=17:44:55
# NAGIOS_TIMET=1263919495
# NAGIOS_TOTALHOSTSERVICES=6
# NAGIOS_TOTALHOSTSERVICESCRITICAL=0
# NAGIOS_TOTALHOSTSERVICESOK=6
# NAGIOS_TOTALHOSTSERVICESUNKNOWN=0
# NAGIOS_TOTALHOSTSERVICESWARNING=0

cat <<EOF | mail -s "Nagios: $NAGIOS_HOSTNAME / $NAGIOS_SERVICEDESC" $NAGIOS_CONTACTEMAIL

  Hostname: $NAGIOS_HOSTNAME
  Alias:    $NAGIOS_HOSTALIAS
  IP:       $NAGIOS_HOSTADDRESS
  Service:  $NAGIOS_SERVICEDESC
  
  Hoststate: $NAGIOS_HOSTSTATE ($NAGIOS_HOSTOUTPUT)
  Service:   $NAGIOS_SERVICESTATE ($NAGIOS_SERVICEOUTPUT)

EOF

