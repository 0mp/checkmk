#!/bin/sh
# +------------------------------------------------------------------+
# |             ____ _               _        __  __ _  __           |
# |            / ___| |__   ___  ___| | __   |  \/  | |/ /           |
# |           | |   | '_ \ / _ \/ __| |/ /   | |\/| | ' /            |
# |           | |___| | | |  __/ (__|   <    | |  | | . \            |
# |            \____|_| |_|\___|\___|_|\_\___|_|  |_|_|\_\           |
# |                                                                  |
# | Copyright Mathias Kettner 2010             mk@mathias-kettner.de |
# +------------------------------------------------------------------+
# 
# This file is part of Check_MK.
# The official homepage is at http://mathias-kettner.de/check_mk.
# 
# check_mk is free software;  you can redistribute it and/or modify it
# under the  terms of the  GNU General Public License  as published by
# the Free Software Foundation in version 2.  check_mk is  distributed
# in the hope that it will be useful, but WITHOUT ANY WARRANTY;  with-
# out even the implied warranty of  MERCHANTABILITY  or  FITNESS FOR A
# PARTICULAR PURPOSE. See the  GNU General Public License for more de-
# ails.  You should have  received  a copy of the  GNU  General Public
# License along with GNU Make; see the file  COPYING.  If  not,  write
# to the Free Software Foundation, Inc., 51 Franklin St,  Fifth Floor,
# Boston, MA 02110-1301 USA.

export MK_LIBDIR="/to/be/changed"
export MK_CONFDIR="/to/be/changed"

# All executables in PLUGINSDIR will simply be executed and their
# ouput appended to the output of the agent. Plugins define their own
# sections and must output headers with '<<<' and '>>>'
PLUGINSDIR=$MK_LIBDIR/plugins

# All executables in LOCALDIR will by executabled and their
# output inserted into the section <<<local>>>. They must
# *not* output a section header. A local extension may output
# zero, one or several lines. Each line must be in the form
# EXITCODE CHECK_NAME PERFDATA CHECK_OUTPUT
# EXITCODE is 0, 1, 2 or 3
# CHECK_NAME will be used as Nagios's service_descriptions and
# must be unique for this host
# PERFDATA is optional performance data in the standard Nagios
# format for variable=value;warn;crit;min;max. You can send
# only one variable currently. If you do not want to send 
# performance data output a single dash instead
# CHECK_OUTPUT will be used by Nagios as the check's output
# EXITCODE, CHECK_NAME and PERFDATA must not contain spaces
# or tabs. CHECK_OUTPUT may contain spaces and tabs
LOCALDIR=$MK_LIBDIR/local


echo '<<<check_mk>>>'
echo Version: 1.1.4atlas3

echo '<<<df>>>'
df -kP | sed 's/ / - /' | grep -v ^/proc | grep -v ^Filesystem

echo '<<<ps>>>'
ps -ef -F args | sed 1d

if type lparstat >/dev/null 2>&1
then
  echo '<<<lparstat_aix>>>'
  lparstat | tail -n1
fi

echo '<<<vmstat_aix>>>'
vmstat | tail -n1

echo '<<<mpstat_aix>>>'
mpstat -a | tail -n1

# CPU output of Linux agent simulated
# (thanks to Cameron Pierce)
echo '<<<cpu>>>'
load=`uptime|sed -e 's;.*average: \([[:digit:]]\{1,\}\.[[:digit:]]\{1,\}\), \([[:digit:]]\{1,\}\.[[:digit:]]\{1,\}\), \([[:digit:]]\{1,\}\.[[:digit:]]\{1,\}\);\1 \2 \3;'`
ps=`ps -ef|wc -l|sed -e 's;[[:space:]]\{1,\};;'`
procs=`vmstat|grep lcpu|sed -e 's;.* lcpu=\([[:digit:]]\{1,2\}\) .*;\1;'`
echo $load 1/$ps $$ $procs


if cd $PLUGINSDIR 2>/dev/null
then
    for skript in $(ls)
    do
        if [ -x "$skript" ] ; then
            ./$skript
    fi
  done
fi


echo '<<<local>>>'
if cd $LOCALDIR 2>/dev/null
then
  for skript in $(ls)
  do
    if [ -x "$skript" ] ; then
        ./$skript
    fi
  done
fi

# MK's Remote Plugin Executor
if [ -e "$MK_CONFDIR/mrpe.cfg" ]
then
    echo '<<<mrpe>>>'
    grep -Ev '^[[:space:]]*($|#)' "$MK_CONFDIR/mrpe.cfg" | \
    while read descr cmdline
    do
        OUTPUT=$($cmdline)
        echo "$descr $? $OUTPUT"
    done
fi
