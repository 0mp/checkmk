#!/usr/bin/python
# encoding: utf-8

from lxml import etree
import hashlib, sys
import inspect, pprint
import urllib

address = "http://fritz.box"
username = ''
password = u"test123"
sidfile = '/tmp/sid_cache'

try:
    """
    Session IDs are valid for 10minutes.
    Cause of the limited number of Session IDs for a fritzbox, why
    have to try to persist thes IDs
    """
    sid = file(sidfile).read()
except IOError:
    sid = ""

login_url = '%s/login_sid.lua' % address
# Try to login with old session id
login_page = etree.parse(login_url+"?sid="+sid).getroot()
sid = login_page.findtext('SID')
# If login with old session id not work, try to get a new one
if sid == "0000000000000000":
    challenge = login_page.findtext('Challenge')
    rep = (challenge + '-' + password).encode('utf-16le') 
    response = challenge + '-' + hashlib.md5(rep).hexdigest()
    login_page = etree.parse(login_url+"?username=%s&response=%s" % (username, response)).getroot()
    sid = login_page.findtext('SID')
    #if still not possible to get an id, exit with error
    if sid == "0000000000000000":
        print "Canot get a session id. Please check passwort"
        sys.exit(1)
    file(sidfile,'w').write(sid)

#Just testing yet:
urls = [
 "system/ecostat.lua",
 "/net/home_auto_overview.lua"

]

print urllib.urlopen("%s/%s?sid=%s" % (address,urls[0], sid)).read()



