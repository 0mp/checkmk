#!/bin/bash
SITE=${SITE:-ev}

# MAKE dist tarball
cd ..
VERSION=$(sed -rn '/^VERSION="(.*)"/s//\1/p' < bin/mknotifyd)
DIRNAME=mknotifyd-$VERSION
rm -rf $DIRNAME
mkdir -p $DIRNAME
rm -f src/mknotify
cp -r web bin $DIRNAME
tar cvzf $DIRNAME.tar.gz --exclude=.git* --exclude=.f12 --exclude=.*.swp $DIRNAME

# Integrate into CMK+OMD
OMD=../../cmk-omd/packages/mknotifyd
mkdir -p $OMD
cp -v $DIRNAME.tar.gz $OMD
sed "s/^VERSION = .*/VERSION = $VERSION/" omd/Makefile > $OMD/Makefile
mkdir -p $OMD/skel/etc/init.d
install -m 755 omd/mknotifyd.init $OMD/skel/etc/init.d/mknotifyd
install -m 755 omd/MKNOTIFYD.hook $OMD
mkdir -p $OMD/skel/etc/check_mk/mknotifyd.d/wato
echo '# Configuration of mknotifyd' > $OMD/skel/etc/check_mk/mknotifyd.mk
echo 'etc/init.d/mknotifyd 755' > $OMD/skel.permissions
mkdir -p $OMD/skel/etc/rc.d
ln -sfn ../init.d/mknotifyd $OMD/skel/etc/rc.d/10-mknotifyd

# Directly put into our test site
if [ -n "$SITE" -a -e "/omd/sites/$SITE" ] ; then
    sudo install -o $SITE -g $SITE -v -m 755 omd/mknotifyd.init /omd/sites/$SITE/etc/init.d/mknotifyd
fi
